

# Fix: Auto-Generated Task Count Not Increasing

## Problem Summary

The "Auto-Generated" count on the Task Management dashboard shows **0** despite the automation system correctly passing `is_auto_generated: true` when creating tasks from bundles.

## Root Cause

In `src/data/adapters/SupabaseAdapter.ts`, the task normalization logic has **two critical bugs** that strip out automation-related fields:

### Bug 1: Field Deletion (Line 1341)
```typescript
delete normalized.isAutoGenerated;  // Deletes the camelCase version
```

This happens **before** mapping `isAutoGenerated` → `is_auto_generated`, so the value is lost.

### Bug 2: Missing Fields in Whitelist (Line 1361)
```typescript
const validTaskFields = ['id', 'title', 'description', 'status', 'priority', 
  'case_id', 'due_date', 'assigned_to', 'created_at', 'updated_at', 
  'completed_date', 'hearing_id', 'tenant_id'];
```

**Missing columns**:
- `is_auto_generated`
- `bundle_id`
- `stage`
- `client_id`
- `case_number`
- `estimated_hours`
- `actual_hours`
- `escalation_level`
- `timezone`
- `due_date_validated`
- `tags`
- `attachments`
- `task_category`
- `sla_hours`
- `assigned_by`
- `creation_stage_code`
- `creation_reason`
- `created_by`

### Database Confirmation
The `tasks` table **does have** `is_auto_generated` and `bundle_id` columns - they just never receive values due to the adapter bug.

---

## Solution

### Update SupabaseAdapter.ts (Lines 1326-1365)

Fix the task normalization to:
1. **Map** `isAutoGenerated` → `is_auto_generated` before deletion
2. **Map** `bundleId` → `bundle_id` before deletion  
3. **Include** all valid task columns in the whitelist

---

### Code Changes

**File**: `src/data/adapters/SupabaseAdapter.ts`

**Current Code** (lines 1326-1365):
```typescript
case 'tasks':
  // Map assignedTo -> assigned_to
  if (normalized.assignedTo && !normalized.assigned_to) {
    normalized.assigned_to = normalized.assignedTo;
  }
  // Map completedAt/completed_at -> completed_date
  if (normalized.completedAt && !normalized.completed_date) {
    normalized.completed_date = normalized.completedAt;
  }
  if (normalized.completed_at && !normalized.completed_date) {
    normalized.completed_date = normalized.completed_at;
  }
  delete normalized.assignedTo;
  delete normalized.completedAt;
  delete normalized.completed_at;
  delete normalized.isAutoGenerated;
  delete normalized.currentFollowUpDate;
  
  // ... FK validation ...
  
  // Keep only valid columns
  const validTaskFields = ['id', 'title', 'description', 'status', 'priority', 
    'case_id', 'due_date', 'assigned_to', 'created_at', 'updated_at', 
    'completed_date', 'hearing_id', 'tenant_id'];
  Object.keys(normalized).forEach(key => {
    if (!validTaskFields.includes(key)) delete normalized[key];
  });
  break;
```

**Updated Code**:
```typescript
case 'tasks':
  // Map assignedTo -> assigned_to
  if (normalized.assignedTo && !normalized.assigned_to) {
    normalized.assigned_to = normalized.assignedTo;
  }
  // Map completedAt/completed_at -> completed_date
  if (normalized.completedAt && !normalized.completed_date) {
    normalized.completed_date = normalized.completedAt;
  }
  if (normalized.completed_at && !normalized.completed_date) {
    normalized.completed_date = normalized.completed_at;
  }
  // Map isAutoGenerated -> is_auto_generated (BEFORE deleting!)
  if (normalized.isAutoGenerated !== undefined && normalized.is_auto_generated === undefined) {
    normalized.is_auto_generated = normalized.isAutoGenerated;
  }
  // Map bundleId -> bundle_id
  if (normalized.bundleId && !normalized.bundle_id) {
    normalized.bundle_id = normalized.bundleId;
  }
  // Map estimatedHours -> estimated_hours
  if (normalized.estimatedHours !== undefined && normalized.estimated_hours === undefined) {
    normalized.estimated_hours = normalized.estimatedHours;
  }
  // Map actualHours -> actual_hours
  if (normalized.actualHours !== undefined && normalized.actual_hours === undefined) {
    normalized.actual_hours = normalized.actualHours;
  }
  // Map escalationLevel -> escalation_level
  if (normalized.escalationLevel !== undefined && normalized.escalation_level === undefined) {
    normalized.escalation_level = normalized.escalationLevel;
  }
  // Map assignedById -> assigned_by
  if (normalized.assignedById && !normalized.assigned_by) {
    normalized.assigned_by = normalized.assignedById;
  }
  // Map clientId -> client_id
  if (normalized.clientId && !normalized.client_id) {
    normalized.client_id = normalized.clientId;
  }
  // Map caseNumber -> case_number
  if (normalized.caseNumber && !normalized.case_number) {
    normalized.case_number = normalized.caseNumber;
  }
  // Map taskCategory -> task_category
  if (normalized.taskCategory && !normalized.task_category) {
    normalized.task_category = normalized.taskCategory;
  }
  // Map dueDateValidated -> due_date_validated
  if (normalized.dueDateValidated !== undefined && normalized.due_date_validated === undefined) {
    normalized.due_date_validated = normalized.dueDateValidated;
  }
  
  // Delete camelCase versions (after mapping)
  delete normalized.assignedTo;
  delete normalized.completedAt;
  delete normalized.completed_at;
  delete normalized.isAutoGenerated;
  delete normalized.bundleId;
  delete normalized.estimatedHours;
  delete normalized.actualHours;
  delete normalized.escalationLevel;
  delete normalized.assignedById;
  delete normalized.clientId;
  delete normalized.caseNumber;
  delete normalized.taskCategory;
  delete normalized.dueDateValidated;
  delete normalized.currentFollowUpDate;
  
  // ... FK validation ...
  
  // Keep only valid columns - COMPLETE LIST matching database schema
  const validTaskFields = [
    'id', 'tenant_id', 'case_id', 'hearing_id', 'title', 'description',
    'assigned_to', 'assigned_by', 'status', 'priority', 'due_date',
    'completed_date', 'created_at', 'updated_at', 'stage', 'client_id',
    'case_number', 'estimated_hours', 'actual_hours', 'is_auto_generated',
    'escalation_level', 'timezone', 'due_date_validated', 'tags', 'bundle_id',
    'attachments', 'creation_stage_code', 'creation_reason', 'task_category',
    'sla_hours', 'created_by'
  ];
  Object.keys(normalized).forEach(key => {
    if (!validTaskFields.includes(key)) delete normalized[key];
  });
  break;
```

---

## Files to Modify

| File | Change |
|------|--------|
| `src/data/adapters/SupabaseAdapter.ts` | Fix task field mapping and update validTaskFields whitelist |

---

## Expected Behavior After Fix

| Action | Before | After |
|--------|--------|-------|
| Create task from bundle | `is_auto_generated` = false (stripped) | `is_auto_generated` = true (preserved) |
| Bundle ID persistence | `bundle_id` = null (stripped) | `bundle_id` = UUID (preserved) |
| Auto-Generated count | 0 (no tasks marked) | Shows actual count |
| Other task fields | Some may be lost | All fields persisted |

---

## Testing Checklist

1. Navigate to Task Automation & Management
2. Trigger a bundle (change case stage or upload document)
3. Verify new tasks have `is_auto_generated = true` in database
4. Verify "Auto-Generated" count increases on dashboard
5. Verify task cards show "Auto" badge
6. Verify existing manual tasks still show `is_auto_generated = false`



# Fix: Task Automation Dashboard - Overdue and Auto-Generated Counts Not Updating

## Problem Summary

The Task Management dashboard shows **0 Overdue** and **0 Auto-Generated** tasks despite:
- 179 tasks having due dates in the past (overdue by date calculation)
- Task bundles being configured to create auto-generated tasks

## Root Cause Analysis

### Issue 1: Overdue Count Shows 0

**Location**: `src/components/tasks/TaskManagement.tsx`, lines 519-527

```typescript
const getTaskStats = () => {
  // ...
  const overdue = state.tasks.filter(t => t.status === 'Overdue').length;  // ‚Üê WRONG
  // ...
};
```

**Problem**: The function counts tasks where `status === 'Overdue'`, but:
- Task status is never automatically set to 'Overdue'
- Other components (like `PendingTasksWidget`) correctly calculate overdue by comparing `dueDate < today`

**Database Evidence**:
- `overdue_by_status_count: 0` (no tasks have status 'Overdue')
- `overdue_by_date_count: 179` (179 tasks have due dates in the past)

### Issue 2: Auto-Generated Count Shows 0

**Location**: `src/components/tasks/TaskManagement.tsx`, line 524

```typescript
const autoGenerated = state.tasks.filter(t => t.isAutoGenerated).length;
```

**Problem**: While the code is correct, no tasks in the database have `is_auto_generated = true`. This could be due to:
1. Task bundles not being triggered (user hasn't triggered stage transitions)
2. Bundle trigger service not being invoked correctly
3. The field not being properly persisted when bundles create tasks

**Database Evidence**:
- `auto_generated_count: 0` (no tasks have is_auto_generated = true)
- Query for tasks with `bundle_id IS NOT NULL` returns empty

---

## Solution

### Fix 1: Calculate Overdue by Due Date (Primary Fix)

Update `getTaskStats()` in `TaskManagement.tsx` to calculate overdue based on due date, not status:

**File**: `src/components/tasks/TaskManagement.tsx` (lines 519-527)

**Current Code**:
```typescript
const getTaskStats = () => {
  const total = state.tasks.length;
  const completed = state.tasks.filter(t => t.status === 'Completed').length;
  const overdue = state.tasks.filter(t => t.status === 'Overdue').length;
  const inProgress = state.tasks.filter(t => t.status === 'In Progress').length;
  const autoGenerated = state.tasks.filter(t => t.isAutoGenerated).length;
  
  return { total, completed, overdue, inProgress, autoGenerated };
};
```

**Updated Code**:
```typescript
const getTaskStats = () => {
  const total = state.tasks.length;
  const completed = state.tasks.filter(t => t.status === 'Completed').length;
  
  // Calculate overdue based on due date, not status field
  // Task is overdue if: due_date < today AND not in terminal state
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  const overdue = state.tasks.filter(t => {
    if (!t.dueDate) return false;
    const terminalStatuses = ['Completed', 'Cancelled'];
    if (terminalStatuses.includes(t.status)) return false;
    try {
      const dueDate = new Date(t.dueDate);
      dueDate.setHours(0, 0, 0, 0);
      return dueDate < now;
    } catch {
      return false;
    }
  }).length;
  
  const inProgress = state.tasks.filter(t => t.status === 'In Progress').length;
  const autoGenerated = state.tasks.filter(t => t.isAutoGenerated === true).length;
  
  return { total, completed, overdue, inProgress, autoGenerated };
};
```

### Fix 2: Update TaskBoard Overdue Column Logic

The TaskBoard also needs to show overdue tasks in the Overdue column based on date, not status.

**File**: `src/components/tasks/TaskBoard.tsx` (lines 77-79)

**Current Code**:
```typescript
const getTasksByStatus = (status: string) => {
  return tasks.filter(task => task.status === status);
};
```

**Updated Code**:
```typescript
const getTasksByStatus = (status: string) => {
  if (status === 'Overdue') {
    // Calculate overdue based on due date, not status
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    return tasks.filter(task => {
      if (!task.dueDate) return false;
      const terminalStatuses = ['Completed', 'Cancelled'];
      if (terminalStatuses.includes(task.status)) return false;
      try {
        const dueDate = new Date(task.dueDate);
        dueDate.setHours(0, 0, 0, 0);
        return dueDate < now;
      } catch {
        return false;
      }
    });
  }
  // For non-Overdue statuses, exclude tasks that would appear in Overdue
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  return tasks.filter(task => {
    const isOverdue = task.dueDate && 
      !['Completed', 'Cancelled'].includes(task.status) &&
      new Date(task.dueDate) < now;
    // Don't show overdue tasks in their original status columns
    if (isOverdue && status !== 'Overdue') return false;
    return task.status === status;
  });
};
```

### Fix 3: Create Reusable Overdue Helper Utility

Extract overdue calculation to a shared utility function for consistency.

**File**: `src/utils/taskHelpers.ts` (new function)

```typescript
/**
 * Determines if a task is overdue based on due date
 * A task is overdue if: due_date < today AND not in terminal state
 */
export const isTaskOverdue = (task: { dueDate?: string; status: string }): boolean => {
  if (!task.dueDate) return false;
  const terminalStatuses = ['Completed', 'Cancelled'];
  if (terminalStatuses.includes(task.status)) return false;
  
  try {
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    const dueDate = new Date(task.dueDate);
    dueDate.setHours(0, 0, 0, 0);
    return dueDate < now;
  } catch {
    return false;
  }
};

/**
 * Counts overdue tasks from a task array
 */
export const countOverdueTasks = (tasks: Array<{ dueDate?: string; status: string }>): number => {
  return tasks.filter(isTaskOverdue).length;
};
```

---

## Files to Modify

| File | Change |
|------|--------|
| `src/utils/taskHelpers.ts` | Add `isTaskOverdue()` and `countOverdueTasks()` helpers |
| `src/components/tasks/TaskManagement.tsx` | Update `getTaskStats()` to use date-based overdue calculation |
| `src/components/tasks/TaskBoard.tsx` | Update `getTasksByStatus()` to show overdue tasks by date in Overdue column |

---

## Expected Behavior After Fix

| Metric | Before | After |
|--------|--------|-------|
| Overdue count in header cards | 0 | 179 (or actual count) |
| Overdue column in Board View | 0 tasks | Shows tasks with past due dates |
| Auto-Generated count | 0 (correct until bundles are triggered) | Will show count when bundles create tasks |

---

## Note on Auto-Generated Tasks

The auto-generated count is correctly coded but shows 0 because no tasks have been created via the bundle trigger system yet. This is expected behavior - once users trigger stage transitions that activate task bundles, the count will increase. No code fix is needed for this metric; it's a data availability issue.

---

## Testing Checklist

1. Navigate to Task Management page
2. Verify Overdue count in header cards shows correct number (matches tasks with past due dates)
3. Switch to Board View - verify Overdue column shows tasks that are past due
4. Verify tasks don't appear in both their status column AND Overdue column
5. Complete an overdue task - verify it moves from Overdue to Completed (no longer overdue)
6. Verify dashboard widget overdue counts match Task Management page counts

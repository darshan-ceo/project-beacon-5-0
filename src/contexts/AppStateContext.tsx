import React, { createContext, useContext, useReducer, ReactNode } from 'react';

// Types
interface GeneratedForm {
  formCode: string;
  version: number;
  generatedDate: string;
  employeeId: string;
  employeeName: string;
  documentId?: string;
  fileName: string;
  status: 'Generated' | 'Uploaded';
}

interface Case {
  id: string;
  caseNumber: string;
  title: string;
  clientId: string; // FK to Client.id
  currentStage: 'Scrutiny' | 'Demand' | 'Adjudication' | 'Appeals' | 'GSTAT' | 'HC' | 'SC';
  priority: 'High' | 'Medium' | 'Low';
  slaStatus: 'Green' | 'Amber' | 'Red';
  nextHearing?: {
    date: string;
    courtId: string; // FK to Court.id
    judgeId: string; // FK to Judge.id
    type: 'Adjourned' | 'Final' | 'Argued';
  };
  assignedToId: string; // FK to Employee.id
  assignedToName: string; // Display name derived from Employee
  createdDate: string;
  lastUpdated: string;
  documents: number;
  progress: number;
  generatedForms: GeneratedForm[]; // Track completed forms
  amountInDispute?: number; // Amount in dispute for GST cases
  description?: string; // Case description
}

interface Task {
  id: string;
  title: string;
  description: string;
  caseId: string; // FK to Case.id (required)
  clientId: string; // Derived from Case.clientId (auto-populated, read-only)
  caseNumber: string; // Derived from Case.caseNumber (auto-populated)
  stage: string;
  priority: 'Critical' | 'High' | 'Medium' | 'Low';
  status: 'Not Started' | 'In Progress' | 'Review' | 'Completed' | 'Overdue';
  assignedToId: string; // FK to Employee.id
  assignedToName: string; // Display name derived from Employee
  assignedById: string; // FK to Employee.id
  assignedByName: string; // Display name derived from Employee
  createdDate: string;
  dueDate: string;
  completedDate?: string;
  estimatedHours: number;
  actualHours?: number;
  isAutoGenerated: boolean;
  bundleId?: string;
  dependencies?: string[];
  attachments?: string[];
  escalationLevel: 0 | 1 | 2 | 3;
}

interface Client {
  id: string;
  name: string;
  type: 'Individual' | 'Company' | 'Partnership' | 'Trust' | 'Other';
  category?: 'Regular Dealer' | 'Composition' | 'Exporter' | 'Service' | 'Other';
  registrationNo?: string;
  gstin?: string;
  pan: string;
  address: Address | string; // Support both new and legacy format
  jurisdiction?: Jurisdiction;
  portalAccess?: PortalAccess;
  signatories?: Signatory[];
  status: 'Active' | 'Inactive';
  assignedCAId: string; // FK to Employee.id  
  assignedCAName: string; // Display name derived from Employee
  createdAt?: string;
  updatedAt?: string;
  // Migration flags
  needsAddressReview?: boolean;
  needsSignatoryReview?: boolean;
  // Legacy support
  email?: string;
  phone?: string;
  registrationNumber?: string;
  panNumber?: string;
  gstNumber?: string;
  registrationDate?: string;
  totalCases?: number;
  activeCases?: number;
  totalInvoiced?: number;
}

interface Court {
  id: string;
  name: string;
  type: 'Supreme Court' | 'High Court' | 'District Court' | 'Tribunal' | 'Commission';
  jurisdiction: string;
  address: string;
  establishedYear: number;
  totalJudges: number;
  activeCases: number;
  avgHearingTime: string;
  digitalFiling: boolean;
  workingDays: string[];
}

interface Judge {
  id: string;
  name: string;
  designation: string;
  courtId: string; // FK to Court.id
  appointmentDate: string;
  specialization: string[];
  totalCases: number;
  avgDisposalTime: string;
  retirementDate: string;
  status: 'Active' | 'On Leave' | 'Retired';
  contactInfo: {
    chambers: string;
    phone?: string;
    email?: string;
  };
}

interface Document {
  id: string;
  name: string;
  type: string;
  size: number;
  caseId: string; // FK to Case.id (required)
  clientId: string; // Derived from Case.clientId (auto-populated)
  uploadedById: string; // FK to Employee.id
  uploadedByName: string; // Display name derived from Employee
  uploadedAt: string;
  tags: string[];
  isShared: boolean;
  path: string;
}

// Employee interface for universal assignment system
export interface Employee {
  id: string;
  full_name: string;
  role: 'Partner' | 'CA' | 'Advocate' | 'Staff' | 'RM' | 'Finance' | 'Admin';
  email: string;
  mobile?: string;
  status: 'Active' | 'Inactive';
  date_of_joining?: string;
  notes?: string;
  department: string;
  workloadCapacity: number;
  specialization?: string[];
}

// New interface for Hearing entity
interface Hearing {
  id: string;
  caseId: string; // FK to Case.id
  clientId: string; // Derived from Case.clientId
  courtId: string; // FK to Court.id
  judgeId: string; // FK to Judge.id
  date: string;
  time: string;
  type: 'Adjourned' | 'Final' | 'Argued' | 'Preliminary';
  status: 'Scheduled' | 'Completed' | 'Postponed' | 'Cancelled';
  agenda: string;
  notes?: string;
  createdDate: string;
  lastUpdated: string;
  // Calendar integration fields
  externalEventId?: string; // ID from Google Calendar/Outlook
  syncStatus?: 'synced' | 'not_synced' | 'sync_failed' | 'sync_pending';
  syncError?: string; // Error message if sync failed
}

// New Folder interface for DMS
interface Folder {
  id: string;
  name: string;
  parentId?: string;
  caseId?: string;
  documentCount: number;
  size: number;
  createdAt: string;
  lastAccess: string;
  description?: string;
  path: string;
}

// Application State
export interface AppState {
  cases: Case[];
  tasks: Task[];
  clients: Client[];
  courts: Court[];
  judges: Judge[];
  documents: Document[];
  folders: Folder[];
  hearings: Hearing[];
  employees: Employee[];
  isLoading: boolean;
  error: string | null;
}

// Actions  
export type AppAction =
  | { type: 'SET_LOADING'; payload: boolean }
  | { type: 'SET_ERROR'; payload: string | null }
  | { type: 'ADD_CASE'; payload: Case }
  | { type: 'UPDATE_CASE'; payload: Partial<Case> & { id: string } }
  | { type: 'DELETE_CASE'; payload: string }
  | { type: 'ADD_TASK'; payload: Task }
  | { type: 'UPDATE_TASK'; payload: Task }
  | { type: 'DELETE_TASK'; payload: string }
  | { type: 'ADD_CLIENT'; payload: Client }
  | { type: 'UPDATE_CLIENT'; payload: Client }
  | { type: 'DELETE_CLIENT'; payload: string }
  | { type: 'ADD_SIGNATORY'; payload: { clientId: string; signatory: Signatory } }
  | { type: 'UPDATE_SIGNATORY'; payload: { clientId: string; signatory: Signatory } }
  | { type: 'DELETE_SIGNATORY'; payload: { clientId: string; signatoryId: string } }
  | { type: 'UPDATE_PORTAL_ACCESS'; payload: { clientId: string; portalAccess: PortalAccess } }
  | { type: 'ADD_COURT'; payload: Court }
  | { type: 'UPDATE_COURT'; payload: Court }
  | { type: 'DELETE_COURT'; payload: string }
  | { type: 'ADD_JUDGE'; payload: Judge }
  | { type: 'UPDATE_JUDGE'; payload: Judge }
  | { type: 'DELETE_JUDGE'; payload: string }
  | { type: 'ADD_DOCUMENT'; payload: Document }
  | { type: 'UPDATE_DOCUMENT'; payload: Partial<Document> & { id: string } }
  | { type: 'DELETE_DOCUMENT'; payload: string }
  | { type: 'ADD_FOLDER'; payload: Folder }
  | { type: 'UPDATE_FOLDER'; payload: Partial<Folder> & { id: string } }
  | { type: 'DELETE_FOLDER'; payload: string }
  | { type: 'ADD_HEARING'; payload: Hearing }
  | { type: 'UPDATE_HEARING'; payload: Partial<Hearing> & { id: string } }
  | { type: 'DELETE_HEARING'; payload: string }
  | { type: 'ADD_EMPLOYEE'; payload: Employee }
  | { type: 'UPDATE_EMPLOYEE'; payload: { id: string; updates: Partial<Employee> } }
  | { type: 'DELETE_EMPLOYEE'; payload: string }
  | { type: 'RESTORE_STATE'; payload: Partial<AppState> }
  | { type: 'CLEAR_ALL_DATA' };

// Initial state with mock data
const initialState: AppState = {
  cases: [
    {
      id: 'GST-001',
      caseNumber: 'GST/2024/001',
      title: 'Input Tax Credit Disallowance - TechCorp Industries',
      clientId: 'CLT-MOCK-001',
      currentStage: 'Appeals',
      priority: 'High',
      slaStatus: 'Green',
      nextHearing: {
        date: '2024-03-15',
        courtId: '1',
        judgeId: '1',
        type: 'Final'
      },
      assignedToId: '2',
      assignedToName: 'Sarah Johnson',
      createdDate: '2024-01-15',
      lastUpdated: '2024-02-20',
      documents: 25,
      progress: 75,
      generatedForms: [
        {
          formCode: 'GSTAT',
          version: 1,
          generatedDate: '2024-01-15T09:30:00Z',
          employeeId: '2',
          employeeName: 'Sarah Johnson',
          documentId: 'doc-gstat-001',
          fileName: 'GSTAT_Form_GST001_20240115.pdf',
          status: 'Uploaded'
        }
      ],
      amountInDispute: 2500000,
      description: 'Challenge to disallowance of Input Tax Credit worth ₹25 lakhs on capital goods purchased for expansion project'
    },
    {
      id: 'GST-002', 
      caseNumber: 'GST/2024/002',
      title: 'Output Tax Liability Dispute - ManufacturingPlus Ltd',
      clientId: 'CLT-MOCK-002',
      currentStage: 'Demand',
      priority: 'High',
      slaStatus: 'Red',
      nextHearing: {
        date: '2024-02-28',
        courtId: '2',
        judgeId: '2', 
        type: 'Final'
      },
      assignedToId: '1',
      assignedToName: 'John Smith',
      createdDate: '2024-01-08',
      lastUpdated: '2024-02-22',
      documents: 42,
      progress: 45,
      generatedForms: [
        {
          formCode: 'DRC07_OBJECTION',
          version: 1,
          generatedDate: '2024-01-20T14:15:00Z',
          employeeId: '1',
          employeeName: 'John Smith', 
          documentId: 'doc-drc07-001',
          fileName: 'DRC07_Objection_GST002_20240120.pdf',
          status: 'Uploaded'
        }
      ],
      amountInDispute: 4500000,
      description: 'Dispute regarding classification of products leading to differential output tax liability of ₹45 lakhs'
    },
    {
      id: 'GST-003',
      caseNumber: 'GST/2024/003', 
      title: 'Reverse Charge Mechanism Non-Compliance - ServiceHub Pvt Ltd',
      clientId: 'CLT-MOCK-003',
      currentStage: 'Demand',
      priority: 'Medium',
      slaStatus: 'Amber',
      assignedToId: '5',
      assignedToName: 'David Kumar',
      createdDate: '2024-01-22',
      lastUpdated: '2024-02-18',
      documents: 18,
      progress: 30,
      generatedForms: [],
      amountInDispute: 1200000,
      description: 'Show cause notice for non-payment of GST under Reverse Charge Mechanism on imported services worth ₹12 lakhs'
    },
    {
      id: 'GST-004',
      caseNumber: 'GST/2024/004',
      title: 'IGST Refund Rejection Appeal - ExportKing Enterprises', 
      clientId: 'CLT-MOCK-004',
      currentStage: 'Appeals',
      priority: 'High',
      slaStatus: 'Green',
      nextHearing: {
        date: '2024-03-08',
        courtId: '1',
        judgeId: '3',
        type: 'Final'
      },
      assignedToId: '2',
      assignedToName: 'Sarah Johnson',
      createdDate: '2024-01-30',
      lastUpdated: '2024-02-25',
      documents: 35,
      progress: 85,
      generatedForms: [
        {
          formCode: 'APPEAL_FIRST',
          version: 1,
          generatedDate: '2024-02-05T11:20:00Z',
          employeeId: '2',
          employeeName: 'Sarah Johnson',
          documentId: 'doc-appeal-001',
          fileName: 'FirstAppeal_GST004_20240205.pdf', 
          status: 'Uploaded'
        }
      ],
      amountInDispute: 3200000,
      description: 'Appeal against rejection of IGST refund claim of ₹32 lakhs on zero-rated export supplies'
    },
    {
      id: 'GST-005',
      caseNumber: 'GST/2024/005',
      title: 'Place of Supply Determination - MultiState Logistics',
      clientId: 'CLT-MOCK-005', 
      currentStage: 'Scrutiny',
      priority: 'Medium',
      slaStatus: 'Amber',
      assignedToId: '4',
      assignedToName: 'Emily Chen',
      createdDate: '2024-02-05',
      lastUpdated: '2024-02-20',
      documents: 22,
      progress: 20,
      generatedForms: [
        {
          formCode: 'ASMT11_REPRESENTATION',
          version: 1,
          generatedDate: '2024-02-10T16:45:00Z',
          employeeId: '4',
          employeeName: 'Emily Chen',
          documentId: 'doc-asmt11-001',
          fileName: 'ASMT11_Representation_GST005_20240210.pdf',
          status: 'Generated'
        }
      ],
      amountInDispute: 1800000,
      description: 'Dispute over place of supply determination for interstate logistics services affecting tax liability by ₹18 lakhs'
    }
  ],
  tasks: [
    {
      id: '1',
      title: 'Draft Response to DRC-01 Notice',
      description: 'Prepare comprehensive response addressing all points raised in the demand notice',
      caseId: '1',
      clientId: '1', // Auto-derived from Case.clientId
      caseNumber: 'CASE-2024-001', // Auto-derived from Case.caseNumber
      stage: 'Demand',
      priority: 'Critical',
      status: 'Overdue',
      assignedToId: '1',
      assignedToName: 'John Smith',
      assignedById: '3',
      assignedByName: 'Mike Wilson',
      createdDate: '2024-01-15',
      dueDate: '2024-01-20',
      estimatedHours: 16,
      actualHours: 20,
      isAutoGenerated: true,
      bundleId: 'demand-response-bundle',
      escalationLevel: 2
    }
  ],
  clients: [
    {
      id: 'CLT-MOCK-001',
      name: 'TechCorp Industries Private Limited',
      type: 'Company',
      email: 'legal@techcorp.in',
      phone: '+91-9876543220',
      address: '15th Floor, Tech Tower, Cyber City, Gurgaon, Haryana - 122002',
      registrationNumber: 'U72200HR2018PTC074521',
      pan: 'AACTC1234M',
      panNumber: 'AACTC1234M',
      gstNumber: '06AACTC1234M1ZX',
      status: 'Active',
      assignedCAId: '2',
      assignedCAName: 'Sarah Johnson',
      registrationDate: '2018-05-15',
      totalCases: 8,
      activeCases: 3,
      totalInvoiced: 850000,
      signatories: [
        {
          id: 'SIG-001',
          fullName: 'Rajesh Gupta',
          designation: 'Chief Executive Officer',
          email: 'rajesh.gupta@techcorp.in',
          phone: '+91-9876543221',
          isPrimary: true,
          scope: 'All',
          status: 'Active'
        }
      ]
    },
    {
      id: 'CLT-MOCK-002',
      name: 'ManufacturingPlus Limited',
      type: 'Company', 
      email: 'compliance@manufacturingplus.com',
      phone: '+91-9876543222',
      address: 'Plot No. 45, Industrial Area Phase-2, Chandigarh - 160002',
      registrationNumber: 'U25200CH2015PLC035896',
      pan: 'AABCM5678N',
      panNumber: 'AABCM5678N',
      gstNumber: '04AABCM5678N1Z1',
      status: 'Active',
      assignedCAId: '1',
      assignedCAName: 'John Smith',
      registrationDate: '2015-03-20',
      totalCases: 12,
      activeCases: 4,
      totalInvoiced: 1250000,
      signatories: [
        {
          id: 'SIG-002',
          fullName: 'Priya Sharma',
          designation: 'Chief Financial Officer',
          email: 'priya.sharma@manufacturingplus.com',
          phone: '+91-9876543223',
          isPrimary: true,
          scope: 'All',
          status: 'Active'
        }
      ]
    },
    {
      id: 'CLT-MOCK-003',
      name: 'ServiceHub Private Limited',
      type: 'Company',
      email: 'info@servicehub.co.in',
      phone: '+91-9876543224',
      address: '3rd Floor, Business Center, MG Road, Bangalore - 560001',
      registrationNumber: 'U74200KA2019PTC125847',
      pan: 'AACSH9012P',
      panNumber: 'AACSH9012P',
      gstNumber: '29AACSH9012P1Z5',
      status: 'Active',
      assignedCAId: '5',
      assignedCAName: 'David Kumar',
      registrationDate: '2019-07-10',
      totalCases: 5,
      activeCases: 2,
      totalInvoiced: 420000,
      signatories: [
        {
          id: 'SIG-003',
          fullName: 'Amit Patel',
          designation: 'Managing Director',
          email: 'amit.patel@servicehub.co.in',
          phone: '+91-9876543225',
          isPrimary: true,
          scope: 'All',
          status: 'Active'
        }
      ]
    },
    {
      id: 'CLT-MOCK-004',
      name: 'ExportKing Enterprises',
      type: 'Company',
      email: 'exports@exportking.in',
      phone: '+91-9876543226',
      address: 'Export House, SEEPZ, Andheri East, Mumbai - 400096',
      registrationNumber: 'U51200MH2020PTC342158',
      pan: 'AABEK3456Q',
      panNumber: 'AABEK3456Q',
      gstNumber: '27AABEK3456Q1ZY',
      status: 'Active',
      assignedCAId: '2',
      assignedCAName: 'Sarah Johnson',
      registrationDate: '2020-01-25',
      totalCases: 6,
      activeCases: 2,
      totalInvoiced: 680000,
      signatories: [
        {
          id: 'SIG-004',
          fullName: 'Sunita Agarwal',
          designation: 'Export Manager',
          email: 'sunita.agarwal@exportking.in',
          phone: '+91-9876543227',
          isPrimary: true,
          scope: 'All',
          status: 'Active'
        }
      ]
    },
    {
      id: 'CLT-MOCK-005',
      name: 'MultiState Logistics Limited',
      type: 'Company',
      email: 'legal@multistatelogistics.com',
      phone: '+91-9876543228',
      address: 'Transport Nagar, Ring Road, New Delhi - 110020',
      registrationNumber: 'U60200DL2017PLC316472',
      pan: 'AACMS7890R',
      panNumber: 'AACMS7890R',
      gstNumber: '07AACMS7890R1Z8',
      status: 'Active',
      assignedCAId: '4',
      assignedCAName: 'Emily Chen',
      registrationDate: '2017-09-15',
      totalCases: 9,
      activeCases: 3,
      totalInvoiced: 920000,
      signatories: [
        {
          id: 'SIG-005',
          fullName: 'Vikram Singh',
          designation: 'General Manager',
          email: 'vikram.singh@multistatelogistics.com',
          phone: '+91-9876543229',
          isPrimary: true,
          scope: 'All',
          status: 'Active'
        }
      ]
    }
  ],
  courts: [
    {
      id: '1',
      name: 'Income Tax Appellate Tribunal',
      type: 'Tribunal',
      jurisdiction: 'Mumbai',
      address: 'Aayakar Bhavan, M.K. Road, Mumbai',
      establishedYear: 1941,
      totalJudges: 15,
      activeCases: 450,
      avgHearingTime: '45 mins',
      digitalFiling: true,
      workingDays: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday']
    }
  ],
  judges: [
    {
      id: '1',
      name: 'Justice Rajesh Sharma',
      designation: 'Chief Justice',
      courtId: '1', // FK to Income Tax Appellate Tribunal
      appointmentDate: '2015-06-15',
      specialization: ['Tax Law', 'Corporate Law'],
      totalCases: 1250,
      avgDisposalTime: '8 months',
      retirementDate: '2030-06-14',
      status: 'Active',
      contactInfo: {
        chambers: 'Chamber No. 15, ITAT Mumbai',
        phone: '+91-22-12345678',
        email: 'justice.sharma@itat.gov.in'
      }
    }
  ],
  documents: [
    {
      id: '1',
      name: 'DRC-01 Notice.pdf',
      type: 'pdf',
      size: 1024000,
      caseId: '1',
      clientId: '1', // Auto-derived from Case.clientId
      uploadedById: '1',
      uploadedByName: 'John Smith',
      uploadedAt: '2024-01-15T10:30:00Z',
      tags: ['Notice', 'DRC-01', 'Important'],
      isShared: false,
      path: '/documents/case-1/drc-01-notice.pdf'
    }
  ],
  folders: [
    {
      id: '1',
      name: 'Litigation Docs',
      documentCount: 15,
      size: 25600000,
      createdAt: '2024-01-10',
      lastAccess: '2024-01-25',
      description: 'Legal documents for litigation cases',
      path: '/folders/litigation-docs'
    },
    {
      id: '2', 
      name: 'GSTAT',
      parentId: '1',
      documentCount: 8,
      size: 12800000,
      createdAt: '2024-01-15',
      lastAccess: '2024-01-24',
      description: 'GSTAT related documents',
      path: '/folders/litigation-docs/gstat'
    },
    {
      id: '3',
      name: 'Client Uploads',
      documentCount: 23,
      size: 35200000,
      createdAt: '2024-01-05',
      lastAccess: '2024-01-25',
      description: 'Documents uploaded by clients',
      path: '/folders/client-uploads'
    }
  ],
  hearings: [
    {
      id: '1',
      caseId: '1',
      clientId: '1', // Auto-derived from Case.clientId
      courtId: '1',
      judgeId: '1',
      date: '2024-02-15',
      time: '10:30',
      type: 'Final',
      status: 'Scheduled',
      agenda: 'Final arguments for tax assessment appeal',
      createdDate: '2024-01-10',
      lastUpdated: '2024-01-20'
    }
  ],
  employees: [
    {
      id: '1',
      full_name: 'John Smith',
      role: 'Partner',
      email: 'john.smith@lawfirm.com',
      mobile: '+91-9876543210',
      status: 'Active',
      date_of_joining: '2018-03-15',
      department: 'Corporate Law',
      workloadCapacity: 40,
      specialization: ['Corporate Law', 'Tax Law', 'Mergers & Acquisitions']
    },
    {
      id: '2',
      full_name: 'Sarah Johnson',
      role: 'Advocate',
      email: 'sarah.johnson@lawfirm.com',
      mobile: '+91-9876543211',
      status: 'Active',
      date_of_joining: '2020-08-01',
      department: 'Tax Law',
      workloadCapacity: 35,
      specialization: ['Tax Law', 'GST', 'Income Tax Appeals']
    },
    {
      id: '3',
      full_name: 'Mike Wilson',
      role: 'Staff',
      email: 'mike.wilson@lawfirm.com',
      mobile: '+91-9876543212',
      status: 'Active',
      date_of_joining: '2017-01-10',
      department: 'Operations',
      workloadCapacity: 30,
      specialization: ['Team Management', 'Operations', 'Client Relations']
    },
    {
      id: '4',
      full_name: 'Emily Chen',
      role: 'Advocate',
      email: 'emily.chen@lawfirm.com',
      mobile: '+91-9876543213',
      status: 'Active',
      date_of_joining: '2022-06-15',
      department: 'Litigation',
      workloadCapacity: 25,
      specialization: ['Litigation', 'Civil Law', 'Commercial Disputes']
    },
    {
      id: '5',
      full_name: 'David Kumar',
      role: 'CA',
      email: 'david.kumar@lawfirm.com',
      mobile: '+91-9876543214',
      status: 'Active',
      date_of_joining: '2019-11-20',
      department: 'Tax Law',
      workloadCapacity: 30,
      specialization: ['Chartered Accountancy', 'Tax Planning', 'Audit']
    },
    {
      id: '6',
      full_name: 'Lisa Patel',
      role: 'Staff',
      email: 'lisa.patel@lawfirm.com',
      mobile: '+91-9876543215',
      status: 'Inactive',
      date_of_joining: '2021-02-12',
      department: 'Support',
      workloadCapacity: 20,
      specialization: ['Research', 'Documentation', 'Case Management']
    }
  ],
  isLoading: false,
  error: null
};

// Reducer
function appReducer(state: AppState, action: AppAction): AppState {
  switch (action.type) {
    case 'SET_LOADING':
      return { ...state, isLoading: action.payload };
    case 'SET_ERROR':
      return { ...state, error: action.payload };
    case 'ADD_CASE':
      return { ...state, cases: [...state.cases, action.payload] };
    case 'UPDATE_CASE':
      return {
        ...state,
        cases: state.cases.map(c => c.id === action.payload.id ? { ...c, ...action.payload } : c)
      };
    case 'DELETE_CASE':
      return {
        ...state,
        cases: state.cases.filter(c => c.id !== action.payload)
      };
    case 'ADD_TASK':
      return { ...state, tasks: [...state.tasks, action.payload] };
    case 'UPDATE_TASK':
      return {
        ...state,
        tasks: state.tasks.map(t => t.id === action.payload.id ? action.payload : t)
      };
    case 'DELETE_TASK':
      return {
        ...state,
        tasks: state.tasks.filter(t => t.id !== action.payload)
      };
    case 'ADD_CLIENT':
      return { ...state, clients: [...state.clients, action.payload] };
    case 'UPDATE_CLIENT':
      return {
        ...state,
        clients: state.clients.map(client => 
          client.id === action.payload.id ? action.payload : client
        )
      };

    case 'DELETE_CLIENT':
      return {
        ...state,
        clients: state.clients.filter(client => client.id !== action.payload)
      };

    case 'ADD_SIGNATORY':
      return {
        ...state,
        clients: state.clients.map(client => 
          client.id === action.payload.clientId
            ? {
                ...client,
                signatories: [...(client.signatories || []), action.payload.signatory]
              }
            : client
        )
      };

    case 'UPDATE_SIGNATORY':
      return {
        ...state,
        clients: state.clients.map(client => 
          client.id === action.payload.clientId
            ? {
                ...client,
                signatories: (client.signatories || []).map(sig =>
                  sig.id === action.payload.signatory.id ? action.payload.signatory : sig
                )
              }
            : client
        )
      };

    case 'DELETE_SIGNATORY':
      return {
        ...state,
        clients: state.clients.map(client => 
          client.id === action.payload.clientId
            ? {
                ...client,
                signatories: (client.signatories || []).filter(sig => sig.id !== action.payload.signatoryId)
              }
            : client
        )
      };

    case 'UPDATE_PORTAL_ACCESS':
      return {
        ...state,
        clients: state.clients.map(client => 
          client.id === action.payload.clientId
            ? {
                ...client,
                portalAccess: action.payload.portalAccess
              }
            : client
        )
      };
    case 'ADD_COURT':
      return { ...state, courts: [...state.courts, action.payload] };
    case 'UPDATE_COURT':
      return {
        ...state,
        courts: state.courts.map(c => c.id === action.payload.id ? action.payload : c)
      };
    case 'DELETE_COURT':
      return {
        ...state,
        courts: state.courts.filter(c => c.id !== action.payload)
      };
    case 'ADD_JUDGE':
      return { ...state, judges: [...state.judges, action.payload] };
    case 'UPDATE_JUDGE':
      return {
        ...state,
        judges: state.judges.map(j => j.id === action.payload.id ? action.payload : j)
      };
    case 'DELETE_JUDGE':
      return {
        ...state,
        judges: state.judges.filter(j => j.id !== action.payload)
      };
    case 'ADD_DOCUMENT':
      return { ...state, documents: [...state.documents, action.payload] };
    case 'UPDATE_DOCUMENT':
      return {
        ...state,
        documents: state.documents.map(d => d.id === action.payload.id ? { ...d, ...action.payload } : d)
      };
    case 'DELETE_DOCUMENT':
      return {
        ...state,
        documents: state.documents.filter(d => d.id !== action.payload)
      };
    case 'ADD_FOLDER':
      return { ...state, folders: [...state.folders, action.payload] };
    case 'UPDATE_FOLDER':
      return {
        ...state,
        folders: state.folders.map(f => f.id === action.payload.id ? { ...f, ...action.payload } : f)
      };
    case 'DELETE_FOLDER':
      return {
        ...state,
        folders: state.folders.filter(f => f.id !== action.payload)
      };
    case 'ADD_HEARING':
      return { ...state, hearings: [...state.hearings, action.payload] };
    case 'UPDATE_HEARING':
      return {
        ...state,
        hearings: state.hearings.map(h => h.id === action.payload.id ? { ...h, ...action.payload } : h)
      };
    case 'DELETE_HEARING':
      return {
        ...state,
        hearings: state.hearings.filter(h => h.id !== action.payload)
      };
    case 'ADD_EMPLOYEE':
      return { ...state, employees: [...state.employees, action.payload] };
    case 'UPDATE_EMPLOYEE':
      return {
        ...state,
        employees: state.employees.map(e => e.id === action.payload.id ? { ...e, ...action.payload.updates } : e)
      };
    case 'DELETE_EMPLOYEE':
      return {
        ...state,
        employees: state.employees.filter(e => e.id !== action.payload)
      };
    case 'RESTORE_STATE':
      return { ...state, ...action.payload };
    case 'CLEAR_ALL_DATA':
      return {
        ...initialState,
        cases: [],
        tasks: [],
        clients: [],
        courts: [],
        judges: [],
        documents: [],
        folders: [],
        hearings: [],
        employees: [],
      };
    default:
      return state;
  }
}

// Context
const AppStateContext = createContext<{
  state: AppState;
  dispatch: React.Dispatch<AppAction>;
} | null>(null);

// Provider
export const AppStateProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [state, dispatch] = useReducer(appReducer, initialState);

  return (
    <AppStateContext.Provider value={{ state, dispatch }}>
      {children}
    </AppStateContext.Provider>
  );
};

// Hook
export const useAppState = () => {
  const context = useContext(AppStateContext);
  if (!context) {
    throw new Error('useAppState must be used within AppStateProvider');
  }
  return context;
};

// Export types  
export type { Case, Task, Client, Court, Judge, Document, Folder, Hearing, GeneratedForm };

// New interfaces for enhanced Client Master
export interface Address {
  line1: string;
  line2?: string;
  city: string;
  state: string;
  pincode: string;
  country: string;
}

export interface Jurisdiction {
  commissionerate?: string;
  division?: string;
  range?: string;
}

export interface PortalAccess {
  allowLogin: boolean;
  email?: string;
  mobile?: string;
  username?: string;
  passwordHash?: string;
}

export interface Signatory {
  id: string;
  fullName: string;
  designation?: string;
  email: string;
  phone?: string;
  isPrimary: boolean;
  scope: 'All' | 'GST Filings' | 'Litigation' | 'Appeals';
  status: 'Active' | 'Inactive';
}
